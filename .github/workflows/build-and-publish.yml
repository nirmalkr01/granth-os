name: Build & Publish GranthOS ISO

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      BUILDS_BUCKET: ${{ secrets.BUILDS_BUCKET }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show repo and Makefile (debug)
        run: |
          pwd && ls -la
          echo "------ Makefile (head) ------"
          head -n 80 Makefile || true

      - name: Install deps
        run: |
          sudo apt update
          sudo apt install -y clang lld nasm xorriso jq awscli unzip curl

      - name: Get Limine (binary)
        run: |
          set -eux
          LIMINE_VER="v10.2.1-binary"
          curl -L -o limine.zip "https://github.com/limine-bootloader/limine/archive/refs/tags/${LIMINE_VER}.zip"
          unzip -q limine.zip
          echo "LIMINE_DIR=$(pwd)/limine-${LIMINE_VER}" >> $GITHUB_ENV
          ls -la "$GITHUB_WORKSPACE/limine-${LIMINE_VER}"

      - name: Build ISO (override Limine path via Make)
        env:
          LIMINE_DIR: ${{ env.LIMINE_DIR }}
        run: |
          set -eux
          # Instead of sed, override the Makefile variable directly:
          make clean
          make LIMINE_DIR_WIN="$LIMINE_DIR"
          sha256sum out/GranthOS.iso | tee checksums.txt

      - name: Create manifest.json
        run: |
          set -eux
          SHA=$(cut -d' ' -f1 checksums.txt)
          TS=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          cat > manifest.json <<EOF
          {
            "version": "latest",
            "iso": "https://${BUILDS_BUCKET}.s3.${AWS_REGION}.amazonaws.com/releases/latest/GranthOS.iso",
            "sha256": "${SHA}",
            "published_at": "${TS}"
          }
          EOF
          cat manifest.json

      - name: Configure AWS creds
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Upload to S3 (latest) - NO ACL (works with ACLs disabled)
        run: |
          set -eux
          aws s3 cp out/GranthOS.iso "s3://${BUILDS_BUCKET}/releases/latest/GranthOS.iso"
          aws s3 cp checksums.txt    "s3://${BUILDS_BUCKET}/releases/latest/checksums.txt"
          aws s3 cp manifest.json    "s3://${BUILDS_BUCKET}/releases/latest/manifest.json" --content-type application/json

      - name: List uploaded files (verify)
        run: |
          aws s3 ls "s3://${BUILDS_BUCKET}/releases/latest/"
          echo "Public ISO URL:"
          echo "https://${BUILDS_BUCKET}.s3.${AWS_REGION}.amazonaws.com/releases/latest/GranthOS.iso"
          echo "Public manifest URL:"
          echo "https://${BUILDS_BUCKET}.s3.${AWS_REGION}.amazonaws.com/releases/latest/manifest.json"
