name: Build & Publish GranthOS ISO

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      BUILDS_BUCKET: ${{ secrets.BUILDS_BUCKET }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show repo and Makefile (debug)
        run: |
          pwd && ls -la
          echo "------ Makefile (head) ------"
          head -n 80 Makefile || true

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y nasm clang lld xorriso qemu-system-x86 ovmf unzip curl jq
          # Ensure AWS CLI v2 is available (skip install if already present)
          if command -v aws >/dev/null 2>&1; then
            echo "AWS CLI already installed:"
            aws --version
          else
            echo "Installing AWS CLI v2..."
            curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
            unzip -q awscliv2.zip
            sudo ./aws/install
            aws --version
          fi

      - name: Get Limine (binary)
        run: |
          set -eux
          LIMINE_VER="v10.2.1-binary"
          curl -L -o limine.zip "https://github.com/limine-bootloader/limine/archive/refs/tags/${LIMINE_VER}.zip"
          unzip -q limine.zip
          # Robustly detect the extracted directory (handles with/without leading 'v')
          LIMINE_DIR_ABS="$(find "$PWD" -maxdepth 1 -type d -name 'limine-*' | head -n1)"
          echo "Detected LIMINE_DIR: ${LIMINE_DIR_ABS}"
          test -d "$LIMINE_DIR_ABS"
          # sanity checks for files we need
          test -f "$LIMINE_DIR_ABS/BOOTX64.EFI"
          test -f "$LIMINE_DIR_ABS/limine-uefi-cd.bin"
          echo "LIMINE_DIR=${LIMINE_DIR_ABS}" >> "$GITHUB_ENV"
          ls -la "$LIMINE_DIR_ABS"

      - name: Build ISO (override Limine path via Make)
        env:
          LIMINE_DIR: ${{ env.LIMINE_DIR }}
        run: |
          set -eux
          make clean
          # Pass Limine dir into your Makefile variable
          make LIMINE_DIR_WIN="$LIMINE_DIR"
          sha256sum out/GranthOS.iso | tee checksums.txt

      - name: Create manifest.json
        run: |
          set -eux
          SHA=$(cut -d' ' -f1 checksums.txt)
          TS=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          cat > manifest.json <<EOF
          {
            "version": "latest",
            "iso": "https://${BUILDS_BUCKET}.s3.${AWS_REGION}.amazonaws.com/releases/latest/GranthOS.iso",
            "sha256": "${SHA}",
            "published_at": "${TS}"
          }
          EOF
          cat manifest.json

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Upload to S3 (latest)
        run: |
          set -eux
          aws s3 cp out/GranthOS.iso "s3://${BUILDS_BUCKET}/releases/latest/GranthOS.iso"
          aws s3 cp checksums.txt    "s3://${BUILDS_BUCKET}/releases/latest/checksums.txt"
          aws s3 cp manifest.json    "s3://${BUILDS_BUCKET}/releases/latest/manifest.json" --content-type application/json

      - name: Verify upload
        run: |
          aws s3 ls "s3://${BUILDS_BUCKET}/releases/latest/"
          echo "✅ Public ISO URL:"
          echo "https://${BUILDS_BUCKET}.s3.${AWS_REGION}.amazonaws.com/releases/latest/GranthOS.iso"
          echo "✅ Public manifest URL:"
          echo "https://${BUILDS_BUCKET}.s3.${AWS_REGION}.amazonaws.com/releases/latest/manifest.json"
